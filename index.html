<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Yespa√±ol</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-glass: rgba(255, 255, 255, 0.06);
            --bg-glass-hover: rgba(255, 255, 255, 0.1);
            --border-glass: rgba(255, 255, 255, 0.1);
            --text-primary: #f5f5f7;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --accent: #ff6b4a;
            --success: #32d74b;
            --warning: #ffd60a;
            --danger: #ff453a;
            --card-radius: 20px;
            --nav-height: 72px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .ambient-bg {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 0;
        }
        .ambient-bg::before {
            content: ''; position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 30% 20%, rgba(255, 107, 74, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 70% 80%, rgba(100, 100, 255, 0.05) 0%, transparent 50%);
            animation: ambientShift 20s ease-in-out infinite;
        }
        @keyframes ambientShift {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(2%, 2%); }
        }

        .app-container {
            position: relative; z-index: 1; height: 100%;
            display: flex; flex-direction: column;
            padding-bottom: calc(var(--nav-height) + var(--safe-bottom));
        }

        .header { padding: 56px 24px 12px; text-align: center; }
        .logo {
            font-size: 2.5rem; font-weight: 700; letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .greeting { font-size: 0.95rem; color: var(--text-secondary); margin-top: 4px; }

        .stats-bar { display: flex; justify-content: center; gap: 28px; padding: 12px 24px; }
        .stat { text-align: center; }
        .stat-value { font-size: 1.6rem; font-weight: 600; }
        .stat-value.streak { color: var(--accent); }
        .stat-value.accuracy { color: var(--success); }
        .stat-label { font-size: 0.65rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }

        .content { flex: 1; overflow-y: auto; padding: 0 20px 24px; -webkit-overflow-scrolling: touch; }
        .content::-webkit-scrollbar { display: none; }

        .section-header { font-size: 0.7rem; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.1em; margin: 20px 4px 10px; }

        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: var(--card-radius);
            padding: 18px; text-decoration: none; color: inherit;
            transition: all 0.2s ease; position: relative; overflow: hidden;
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent); }
        .card:active { transform: scale(0.97); background: var(--bg-glass-hover); }
        .card-full { grid-column: 1 / -1; }
        .card-icon { font-size: 1.75rem; margin-bottom: 10px; }
        .card-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 3px; }
        .card-desc { font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4; }

        .skill-bar { margin-top: 10px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; }
        .skill-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #ff8a6a); border-radius: 2px; transition: width 0.5s ease; }
        .skill-label { font-size: 0.65rem; color: var(--text-tertiary); margin-top: 5px; display: flex; justify-content: space-between; }

        .card-featured { background: linear-gradient(135deg, rgba(255, 107, 74, 0.12) 0%, rgba(255, 107, 74, 0.04) 100%); border-color: rgba(255, 107, 74, 0.2); }
        .card-featured .card-title { color: var(--accent); }

        .card-mystery { background: linear-gradient(135deg, rgba(147, 112, 219, 0.12) 0%, rgba(147, 112, 219, 0.04) 100%); border-color: rgba(147, 112, 219, 0.3); }
        .card-mystery .card-icon { animation: mystery-pulse 3s ease-in-out infinite; }
        .card-mystery .card-title { color: #9370db; }
        .card-mystery.locked { opacity: 0.6; pointer-events: none; }
        .card-mystery.locked .card-icon { filter: grayscale(1); animation: none; }
        @keyframes mystery-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .glitch-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .glitch-overlay.visible { opacity: 1; }
        .glitch-message { background: rgba(0, 0, 0, 0.9); color: #9370db; padding: 16px 28px; border-radius: 12px; font-family: monospace; font-size: 0.9rem; border: 1px solid rgba(147, 112, 219, 0.3); text-shadow: 0 0 10px rgba(147, 112, 219, 0.5); animation: glitch-flicker 0.1s infinite; }
        @keyframes glitch-flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        .weak-badge { position: absolute; top: 10px; right: 10px; background: rgba(255, 69, 58, 0.15); color: var(--danger); font-size: 0.55rem; font-weight: 600; padding: 3px 6px; border-radius: 5px; text-transform: uppercase; }

        .today-banner {
            background: linear-gradient(135deg, var(--bg-glass) 0%, rgba(255, 107, 74, 0.1) 100%);
            border: 1px solid var(--border-glass); border-radius: var(--card-radius);
            padding: 18px; margin-bottom: 10px; position: relative; overflow: hidden;
        }
        .today-banner::after { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255, 107, 74, 0.08) 0%, transparent 70%); pointer-events: none; }
        .today-eyebrow { font-size: 0.65rem; font-weight: 600; color: var(--accent); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 6px; }
        .today-title { font-size: 1.15rem; font-weight: 600; margin-bottom: 4px; }
        .today-desc { font-size: 0.8rem; color: var(--text-secondary); }
        .today-btn { display: inline-flex; align-items: center; gap: 6px; margin-top: 14px; padding: 11px 22px; background: var(--accent); color: #000; font-size: 0.85rem; font-weight: 600; border-radius: 12px; border: none; cursor: pointer; }
        .today-btn:active { transform: scale(0.96); }

        .quick-row { display: flex; gap: 8px; margin-top: 10px; }
        .quick-btn { flex: 1; background: var(--bg-glass); border: 1px solid var(--border-glass); border-radius: 12px; padding: 12px; color: var(--text-primary); font-size: 0.8rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .quick-btn:active { transform: scale(0.96); background: var(--bg-glass-hover); }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: calc(var(--nav-height) + var(--safe-bottom)); padding-bottom: var(--safe-bottom);
            background: rgba(10, 10, 15, 0.85); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-top: 1px solid var(--border-glass);
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 8px 16px; color: var(--text-tertiary); text-decoration: none; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 1.3rem; }
        .nav-label { font-size: 0.55rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.03em; }

        .welcome-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
        .welcome-overlay.visible { display: flex; }
        .welcome-modal { background: var(--bg-glass); border: 1px solid var(--border-glass); border-radius: var(--card-radius); padding: 28px; text-align: center; max-width: 340px; }
        .welcome-icon { font-size: 3.5rem; margin-bottom: 12px; }
        .welcome-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 10px; }
        .welcome-desc { color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem; line-height: 1.5; }
        .welcome-btn { width: 100%; padding: 14px; background: var(--accent); color: #000; font-size: 0.95rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; }

        /* Mode selector */
        .mode-selector { display: flex; gap: 8px; padding: 0 20px; margin-bottom: 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .mode-selector::-webkit-scrollbar { display: none; }
        .mode-btn { flex-shrink: 0; background: var(--bg-glass); border: 1px solid var(--border-glass); border-radius: 12px; padding: 10px 16px; color: var(--text-secondary); font-size: 0.8rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease; }
        .mode-btn:active { transform: scale(0.96); }
        .mode-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .mode-btn.story { border-color: rgba(147, 112, 219, 0.3); }
        .mode-btn.story.active { background: #9370db; border-color: #9370db; }
        .mode-icon { font-size: 1rem; }

        /* Did You Know card */
        .fact-card {
            background: linear-gradient(135deg, rgba(100, 100, 255, 0.08) 0%, rgba(255, 107, 74, 0.08) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px; padding: 16px; margin: 16px 0;
            position: relative; overflow: hidden;
        }
        .fact-card::before {
            content: ''; position: absolute; top: 0; right: 0;
            width: 80px; height: 80px;
            background: radial-gradient(circle, rgba(255, 107, 74, 0.15) 0%, transparent 70%);
        }
        .fact-label { font-size: 0.65rem; font-weight: 600; color: var(--accent); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .fact-text { font-size: 0.9rem; color: var(--text-primary); line-height: 1.5; }
        .fact-detail { font-size: 0.8rem; color: var(--text-tertiary); margin-top: 6px; }
        .fact-refresh { position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--text-tertiary); font-size: 1rem; cursor: pointer; padding: 4px; }
        .fact-refresh:active { transform: rotate(180deg); }

        @media (min-width: 500px) { .card-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 768px) { .content { max-width: 560px; margin: 0 auto; } }
    </style>
</head>
<body>
    <div class="ambient-bg"></div>

    <div class="app-container">
        <header class="header">
            <h1 class="logo">Yespa√±ol</h1>
            <p class="greeting" id="greeting">¬°Hola!</p>
        </header>

        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value streak" id="streak">0</div>
                <div class="stat-label">Streak</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="cards">0</div>
                <div class="stat-label">Cards</div>
            </div>
            <div class="stat">
                <div class="stat-value accuracy" id="accuracy">‚Äî</div>
                <div class="stat-label">Accuracy</div>
            </div>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn story active" data-mode="story">
                <span class="mode-icon">üíú</span> Story Mode
            </button>
            <button class="mode-btn" data-mode="classic">
                <span class="mode-icon">üìö</span> Classic
            </button>
            <button class="mode-btn" data-mode="speed">
                <span class="mode-icon">‚ö°</span> Speed
            </button>
            <button class="mode-btn" data-mode="review">
                <span class="mode-icon">üîÑ</span> Review
            </button>
        </div>

        <main class="content">
            <div class="today-banner" id="todayBanner">
                <div class="today-eyebrow" id="todayEyebrow">Recommended</div>
                <div class="today-title" id="todayTitle">Ser vs Estar</div>
                <div class="today-desc" id="todayDesc">Start here ‚Äî the foundation of Spanish.</div>
                <button class="today-btn" id="todayBtn">Start Lesson ‚Üí</button>
            </div>

            <div class="quick-row">
                <button class="quick-btn" onclick="goTo('practice/flashcards.html')">‚ö° Quick Review</button>
                <button class="quick-btn" onclick="goTo('practice/reading.html')">üìñ Reading</button>
            </div>

            <!-- Did You Know fact card -->
            <div class="fact-card" id="factCard">
                <button class="fact-refresh" onclick="refreshFact()" title="New fact">‚Üª</button>
                <div class="fact-label">üí° Did you know?</div>
                <div class="fact-text" id="factText">Loading...</div>
                <div class="fact-detail" id="factDetail"></div>
            </div>

            <div class="section-header">Grammar</div>
            <div class="card-grid" id="grammarGrid">
                <a href="grammar/ser-estar.html" class="card" data-skill="ser-estar">
                    <div class="card-icon">‚öñÔ∏è</div>
                    <div class="card-title">Ser vs Estar</div>
                    <div class="card-desc">The essential distinction</div>
                    <div class="skill-bar"><div class="skill-fill" data-skill-bar="ser-estar"></div></div>
                    <div class="skill-label"><span class="level-text">Beginner</span><span class="level-pct">0%</span></div>
                </a>
                <a href="grammar/por-para.html" class="card" data-skill="por-para">
                    <div class="card-icon">üîÄ</div>
                    <div class="card-title">Por vs Para</div>
                    <div class="card-desc">Context is everything</div>
                    <div class="skill-bar"><div class="skill-fill" data-skill-bar="por-para"></div></div>
                    <div class="skill-label"><span class="level-text">Beginner</span><span class="level-pct">0%</span></div>
                </a>
                <a href="grammar/subjunctive.html" class="card" data-skill="subjunctive">
                    <div class="card-icon">üí≠</div>
                    <div class="card-title">Subjunctive</div>
                    <div class="card-desc">Express wishes & doubt</div>
                    <div class="skill-bar"><div class="skill-fill" data-skill-bar="subjunctive"></div></div>
                    <div class="skill-label"><span class="level-text">Beginner</span><span class="level-pct">0%</span></div>
                </a>
                <a href="grammar/preterite-imperfect.html" class="card" data-skill="preterite-imperfect">
                    <div class="card-icon">‚è≥</div>
                    <div class="card-title">Past Tenses</div>
                    <div class="card-desc">Preterite vs Imperfect</div>
                    <div class="skill-bar"><div class="skill-fill" data-skill-bar="preterite-imperfect"></div></div>
                    <div class="skill-label"><span class="level-text">Beginner</span><span class="level-pct">0%</span></div>
                </a>
            </div>

            <div class="section-header">Vocabulary</div>
            <div class="card-grid">
                <a href="vocabulary/everyday.html" class="card" data-skill="vocabulary">
                    <div class="card-icon">üó£Ô∏è</div>
                    <div class="card-title">Everyday</div>
                    <div class="card-desc">Common words</div>
                </a>
                <a href="vocabulary/idioms.html" class="card" data-skill="idioms">
                    <div class="card-icon">üé≠</div>
                    <div class="card-title">Idioms</div>
                    <div class="card-desc">Sound native</div>
                </a>
                <a href="vocabulary/false-friends.html" class="card" data-skill="false-friends">
                    <div class="card-icon">üö´</div>
                    <div class="card-title">False Friends</div>
                    <div class="card-desc">Avoid traps</div>
                </a>
                <a href="vocabulary/travel.html" class="card">
                    <div class="card-icon">‚úàÔ∏è</div>
                    <div class="card-title">Travel</div>
                    <div class="card-desc">Navigate anywhere</div>
                </a>
            </div>

            <div class="section-header">Tools</div>
            <div class="card-grid">
                <a href="practice/flashcards.html" class="card card-full">
                    <div class="card-icon">üÉè</div>
                    <div class="card-title">Flashcards</div>
                    <div class="card-desc">Spaced repetition ‚Äî your mistakes become your curriculum</div>
                </a>
                <a href="practice/reading.html" class="card">
                    <div class="card-icon">üìñ</div>
                    <div class="card-title">Reading</div>
                    <div class="card-desc">Real Spanish texts</div>
                </a>
                <a href="tools/conjugator.html" class="card">
                    <div class="card-icon">üîß</div>
                    <div class="card-title">Conjugator</div>
                    <div class="card-desc">Any verb, all tenses</div>
                </a>
                <a href="progress.html" class="card">
                    <div class="card-icon">üìä</div>
                    <div class="card-title">Progress</div>
                    <div class="card-desc">Your journey</div>
                </a>
                <a href="mensaje.html" class="card card-mystery" id="mysteryCard" style="display: none;">
                    <div class="card-icon">‚úâÔ∏è</div>
                    <div class="card-title" id="mysteryTitle">???</div>
                    <div class="card-desc" id="mysteryDesc">Locked</div>
                </a>
            </div>
        </main>

        <!-- Glitch message overlay -->
        <div class="glitch-overlay" id="glitchOverlay">
            <div class="glitch-message" id="glitchMessage"></div>
        </div>

        <nav class="bottom-nav">
            <a href="index.html" class="nav-item active"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></a>
            <a href="practice/flashcards.html" class="nav-item"><span class="nav-icon">üÉè</span><span class="nav-label">Review</span></a>
            <a href="progress.html" class="nav-item"><span class="nav-icon">üìä</span><span class="nav-label">Stats</span></a>
            <a href="settings.html" class="nav-item"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Settings</span></a>
        </nav>
    </div>

    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-modal">
            <div class="welcome-icon">üá™üá∏</div>
            <div class="welcome-title">Welcome to Yespa√±ol!</div>
            <div class="welcome-desc">Learn Spanish with science-backed methods. We track your weak spots and personalize your journey.</div>
            <button class="welcome-btn" onclick="dismissWelcome()">¬°Vamos!</button>
        </div>
    </div>

    <script src="js/core.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/story.js"></script>
    <script src="js/loading.js"></script>
    <script>
        const skillUrls = {
            'ser-estar': 'grammar/ser-estar.html',
            'por-para': 'grammar/por-para.html',
            'subjunctive': 'grammar/subjunctive.html',
            'preterite-imperfect': 'grammar/preterite-imperfect.html',
            'vocabulary': 'vocabulary/everyday.html',
            'idioms': 'vocabulary/idioms.html',
            'false-friends': 'vocabulary/false-friends.html',
        };

        function goTo(url) {
            // Show loading screen with Spanish fact
            if (typeof YespanolLoading !== 'undefined') {
                const isStoryMode = url.includes('mode=story');
                if (isStoryMode) {
                    YespanolLoading.showStory(null, 1500);
                } else {
                    YespanolLoading.showFact(1200);
                }
                setTimeout(() => {
                    location.href = url;
                }, isStoryMode ? 1500 : 1200);
            } else if (typeof YespanolUI !== 'undefined') {
                YespanolUI.pageTransition(url);
            } else {
                location.href = url;
            }
        }

        // Did You Know fact refresh
        function refreshFact() {
            if (typeof YespanolLoading !== 'undefined') {
                const fact = YespanolLoading.getRandomFact();
                document.getElementById('factText').textContent = fact.fact;
                document.getElementById('factDetail').textContent = fact.detail;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize fact card
            refreshFact();
            const profile = Yespanol.load();

            // First-time user welcome
            if (!profile.totalCardsReviewed && !localStorage.getItem('yespanol_welcomed')) {
                document.getElementById('welcomeOverlay').classList.add('visible');
            }

            // Update streak
            Yespanol.updateStreak(profile);
            Yespanol.save(profile);

            // Stats
            document.getElementById('streak').textContent = profile.streak || 0;
            document.getElementById('cards').textContent = profile.totalCardsReviewed || 0;
            document.getElementById('accuracy').textContent = profile.totalCardsReviewed > 0 ? Yespanol.getAccuracy(profile) + '%' : '‚Äî';

            // Greeting
            const hour = new Date().getHours();
            let greeting = hour < 12 ? '¬°Buenos d√≠as!' : hour < 18 ? '¬°Buenas tardes!' : '¬°Buenas noches!';
            if (profile.streak >= 3) greeting += ` üî• ${profile.streak} day streak!`;
            document.getElementById('greeting').textContent = greeting;

            // Recommended lesson based on weak areas
            const recommended = Yespanol.getRecommendedLesson(profile);
            document.getElementById('todayTitle').textContent = Yespanol.formatSkillName(recommended.skill);
            document.getElementById('todayDesc').textContent = recommended.reason;
            document.getElementById('todayBtn').onclick = () => goTo(skillUrls[recommended.skill]);

            // Update skill progress bars and mark weak areas
            document.querySelectorAll('[data-skill]').forEach(card => {
                const skill = card.dataset.skill;
                const data = profile.skills[skill];
                if (data && data.attempts > 0) {
                    const bar = card.querySelector('[data-skill-bar]');
                    if (bar) bar.style.width = data.level + '%';

                    const levelText = card.querySelector('.level-text');
                    const levelPct = card.querySelector('.level-pct');
                    if (levelText) {
                        levelText.textContent = data.level < 25 ? 'Beginner' : data.level < 50 ? 'Developing' : data.level < 75 ? 'Intermediate' : 'Advanced';
                    }
                    if (levelPct) levelPct.textContent = data.level + '%';

                    // Mark weak areas
                    if (data.level < 30 && data.attempts >= 5) {
                        card.classList.add('card-featured');
                        const badge = document.createElement('div');
                        badge.className = 'weak-badge';
                        badge.textContent = 'Needs work';
                        card.appendChild(badge);
                    }
                }
            });

            // Smooth transitions for all cards
            document.querySelectorAll('.card[href]').forEach(card => {
                card.addEventListener('click', e => {
                    e.preventDefault();
                    goTo(card.getAttribute('href'));
                });
            });

            // Mode selector logic
            const modeButtons = document.querySelectorAll('.mode-btn');
            const savedMode = localStorage.getItem('yespanol_mode') || 'story';
            setMode(savedMode);

            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    setMode(mode);
                    localStorage.setItem('yespanol_mode', mode);
                });
            });

            function setMode(mode) {
                modeButtons.forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`)?.classList.add('active');
                updateUIForMode(mode, profile);
            }

            function updateUIForMode(mode, profile) {
                const todayBanner = document.getElementById('todayBanner');
                const eyebrow = document.getElementById('todayEyebrow');
                const title = document.getElementById('todayTitle');
                const desc = document.getElementById('todayDesc');
                const btn = document.getElementById('todayBtn');

                switch(mode) {
                    case 'story':
                        const phase = typeof Story !== 'undefined' ? Story.getPhase(calculateOverallProgress(profile)) : 1;
                        eyebrow.textContent = 'El Algoritmo del Amor';
                        title.textContent = phase < 3 ? 'Continue Your Path' : 'He\'s Getting Closer';
                        desc.textContent = getStoryHint(phase);
                        btn.textContent = 'Continue Story ‚Üí';
                        btn.onclick = () => goTo('practice/flashcards.html?mode=story');
                        break;
                    case 'classic':
                        const rec = Yespanol.getRecommendedLesson(profile);
                        eyebrow.textContent = 'Recommended';
                        title.textContent = Yespanol.formatSkillName(rec.skill);
                        desc.textContent = rec.reason;
                        btn.textContent = 'Start Lesson ‚Üí';
                        btn.onclick = () => goTo(skillUrls[rec.skill]);
                        break;
                    case 'speed':
                        eyebrow.textContent = '‚ö° Speed Round';
                        title.textContent = '60-Second Challenge';
                        desc.textContent = 'How many cards can you get right in 60 seconds?';
                        btn.textContent = 'Start Challenge ‚Üí';
                        btn.onclick = () => goTo('practice/flashcards.html?mode=speed');
                        break;
                    case 'review':
                        const dueCards = Yespanol.getDueCards(profile).length;
                        eyebrow.textContent = 'Spaced Repetition';
                        title.textContent = dueCards > 0 ? `${dueCards} Cards Due` : 'All Caught Up!';
                        desc.textContent = dueCards > 0 ? 'Review cards scheduled for today' : 'Come back later for more reviews';
                        btn.textContent = dueCards > 0 ? 'Review Now ‚Üí' : 'Practice Anyway ‚Üí';
                        btn.onclick = () => goTo('practice/flashcards.html?mode=review');
                        break;
                }
            }

            function getStoryHint(phase) {
                const hints = [
                    'Every word you learn brings you closer...',
                    'Someone is waiting. Keep learning.',
                    'The algorithm is working. Trust it.',
                    'He asked about you today.',
                    'The message is almost ready.'
                ];
                return hints[phase - 1] || hints[0];
            }

            // ===== EL ALGORITMO DEL AMOR =====
            if (typeof Story !== 'undefined') {
                const story = Story.load();
                const overallProgress = calculateOverallProgress(profile);
                const phase = Story.getPhase(overallProgress);

                // Show mystery card at phase 3+
                const mysteryCard = document.getElementById('mysteryCard');
                if (phase >= 3 && mysteryCard) {
                    mysteryCard.style.display = 'block';

                    if (phase < 5) {
                        mysteryCard.classList.add('locked');
                        document.getElementById('mysteryTitle').textContent = '???';
                        document.getElementById('mysteryDesc').textContent = 'Not yet...';
                    } else {
                        mysteryCard.classList.remove('locked');
                        document.getElementById('mysteryTitle').textContent = 'El Mensaje';
                        document.getElementById('mysteryDesc').textContent = 'He wrote to you.';
                    }
                }

                // Random glitch messages (5% chance per visit after phase 2)
                if (phase >= 2 && Math.random() < 0.05) {
                    setTimeout(() => showGlitch(Story.getGlitchMessage(story, phase)), 3000 + Math.random() * 5000);
                }
            }
        });

        function calculateOverallProgress(profile) {
            const skills = Object.values(profile.skills || {});
            if (skills.length === 0) return 0;
            const total = skills.reduce((sum, s) => sum + (s.level || 0), 0);
            return Math.round(total / skills.length);
        }

        function showGlitch(message) {
            const overlay = document.getElementById('glitchOverlay');
            const msgEl = document.getElementById('glitchMessage');
            if (!overlay || !msgEl) return;

            msgEl.textContent = message;
            overlay.classList.add('visible');

            setTimeout(() => {
                overlay.classList.remove('visible');
            }, 2000);
        }

        function dismissWelcome() {
            document.getElementById('welcomeOverlay').classList.remove('visible');
            localStorage.setItem('yespanol_welcomed', 'true');
            if (typeof YespanolUI !== 'undefined') YespanolUI.confetti();
        }

        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
